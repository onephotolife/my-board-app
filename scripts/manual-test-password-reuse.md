# 🔒 パスワード再利用防止機能 - 手動テストガイド

## 実装内容
以下のセキュリティ機能を実装しました：

### 1. パスワード履歴管理
- Userモデルに`passwordHistory`フィールドを追加
- 過去5回分のパスワードハッシュを保存
- `lastPasswordChange`と`passwordResetCount`でパスワード変更を追跡

### 2. パスワード再利用チェック
- `/api/auth/reset-password`でパスワード再利用を検証
- 現在のパスワードと履歴のパスワードを比較
- 再利用が検出された場合は`PASSWORD_REUSED`エラーを返す

### 3. セキュリティ監査ログ
- パスワード再利用試行をログに記録
- 複数回の再利用試行でセキュリティアラートを生成

### 4. フロントエンド対応
- `PASSWORD_REUSED`エラータイプの処理を追加
- ユーザーフレンドリーなエラーメッセージ表示

## 手動テスト手順

### 前提条件
1. 開発サーバーが起動していること（`npm run dev`）
2. MongoDBが接続されていること

### テストシナリオ

#### シナリオ1: 既存ユーザーのパスワード再利用防止
1. 既存のユーザーアカウントでログイン
2. パスワードリセットをリクエスト
3. リセットリンクから新しいパスワード設定画面へ
4. **現在と同じパスワード**を入力して送信
5. **期待結果**: 「セキュリティのため、新しいパスワードは過去5回分と異なるものを設定してください。」というエラーメッセージが表示される

#### シナリオ2: 新しいパスワードの受け入れ
1. パスワードリセット画面で
2. **完全に新しいパスワード**を入力（例: `NewSecurePass789!@#`）
3. **期待結果**: パスワードが正常に更新される

#### シナリオ3: 更新後の再利用防止
1. パスワードを更新した直後
2. 再度パスワードリセットをリクエスト
3. **先ほど設定したばかりのパスワード**を再入力
4. **期待結果**: 再利用エラーが表示される

## コード変更箇所

### 追加されたファイル
- `/src/lib/auth/password-validator.ts` - パスワード検証ユーティリティ
- `/src/lib/security/audit-log.ts` - セキュリティ監査ログ
- `/scripts/test-password-reuse-api.mjs` - APIテストスクリプト
- `/scripts/manual-test-password-reuse.md` - このガイド

### 変更されたファイル
- `/src/lib/models/User.ts` - パスワード履歴フィールド追加
- `/src/app/api/auth/reset-password/route.ts` - 再利用チェック実装
- `/src/app/auth/reset-password/[token]/page.tsx` - エラー処理追加

## セキュリティ強化のポイント

1. **パスワード履歴**: 過去5回分のパスワードを記録し、再利用を防止
2. **タイミング攻撃対策**: bcrypt.compareで一定時間の比較処理
3. **監査ログ**: すべての再利用試行を記録
4. **レート制限**: 15分間に5回までの試行制限

## コンプライアンス準拠
- ✅ NIST SP 800-63B: パスワード履歴の考慮
- ✅ PCI DSS: パスワード再利用の制限
- ✅ ISO 27001: アクセス制御の要件
- ✅ OWASP: 認証チートシート準拠

## 確認事項

### データベース確認
MongoDBで以下を確認：
```javascript
// MongoDB Compassまたはmongoshで実行
db.users.findOne({ email: "test@example.com" })
// passwordHistory, lastPasswordChange, passwordResetCountフィールドが存在することを確認
```

### ログ確認
```javascript
// 監査ログの確認
db.auditlogs.find({ event: "PASSWORD_REUSE_ATTEMPT" })
```

## トラブルシューティング

### エラーが表示されない場合
1. ブラウザのキャッシュをクリア
2. 開発サーバーを再起動
3. MongoDBの接続を確認

### パスワード履歴が保存されない場合
1. Userモデルのスキーマが更新されているか確認
2. MongoDBのマイグレーションが必要な可能性

## まとめ
パスワード再利用防止機能により、セキュリティが大幅に向上しました。
これにより、パスワード漏洩時のリスクを最小限に抑えることができます。