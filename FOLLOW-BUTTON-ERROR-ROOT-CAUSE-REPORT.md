# フォローボタンエラー 根本原因分析レポート

## エグゼクティブサマリー

**問題**: http://localhost:3000/board でフォローボタンクリック時に404エラーが発生  
**エラーメッセージ**: "フォロー対象のユーザーが見つかりません"  
**根本原因**: Postコレクション内のauthor情報とUserコレクションのデータ不整合

---

## 1. 問題の詳細

### 1.1 エラー現象
```
Error: フォロー対象のユーザーが見つかりません
POST http://localhost:3000/api/users/68a8182…/follow 404 (Not Found)
```

### 1.2 発生場所
- **ページ**: `/board` (RealtimeBoardコンポーネント)
- **コンポーネント**: FollowButton (877-893行目で使用)
- **API**: `/api/users/[userId]/follow`

---

## 2. 調査結果

### 2.1 データ構造の分析

#### Postモデル (src/lib/models/Post.ts)
```javascript
author: {
  _id: { type: String, required: true },     // 文字列型として保存
  name: { type: String, required: true },
  email: { type: String, required: true }
}
```

#### Userモデル (src/lib/models/User.ts)
```javascript
// MongoDBのObjectID型として保存
_id: ObjectId('68afac8ef30f58c749a43a4c')
```

### 2.2 データ不整合の証拠

#### 実行したテストクエリ
```javascript
// エラーで報告されているユーザーIDの存在確認
const errorReportedIds = [
  '68a8182040abde7f4273e6e9',
  '68a8176840abde7f4273e6e9',
  '68a817542d683a50b97c20b2',
  '68a816974d583357364d1188',
  '68a81606ad0864284c5021ec'
];
```

#### 検証結果
| ユーザーID | Userコレクション | Postコレクション（author._id） | 結果 |
|-----------|----------------|--------------------------|------|
| 68a8182040abde7f4273e6e9 | 存在しない | 存在する | ❌ 不整合 |
| 68a8176840abde7f4273e6e9 | 存在しない | 存在する（投稿あり） | ❌ 不整合 |
| 68a817542d683a50b97c20b2 | 存在しない | 存在する | ❌ 不整合 |
| 68a816974d583357364d1188 | 存在しない | 存在する | ❌ 不整合 |
| 68a81606ad0864284c5021ec | 存在しない | 存在する | ❌ 不整合 |

---

## 3. 問題の流れ

### 3.1 正常な処理フロー（期待される動作）
```
1. /boardページで投稿一覧を表示
2. 各投稿にFollowButtonを表示（post.author._id を userId として渡す）
3. FollowButtonクリック時、/api/users/[userId]/followを呼び出し
4. APIでUser.findById(userId)を実行
5. ユーザーが見つかり、フォロー処理を実行
```

### 3.2 実際の処理フロー（エラー発生）
```
1. /boardページで投稿一覧を表示 ✅
2. 各投稿にFollowButtonを表示（post.author._id を userId として渡す） ✅
3. FollowButtonクリック時、/api/users/[userId]/followを呼び出し ✅
4. APIでUser.findById(userId)を実行 ✅
5. ユーザーが見つからず404エラー ❌
   → "フォロー対象のユーザーが見つかりません"
```

---

## 4. 根本原因

### 4.1 データ不整合の原因

1. **削除されたユーザーの投稿が残存**
   - ユーザーが削除されても、そのユーザーの投稿は削除されていない
   - Postコレクションにはauthor情報が埋め込み形式で保存されている

2. **テストデータの不適切な作成**
   - テストで作成された投稿に、実在しないユーザーIDが設定されている可能性
   - 例：`author._id: '68a8176840abde7f4273e6e9'` の投稿は存在するが、該当ユーザーは存在しない

3. **参照整合性の欠如**
   - MongoDBは外部キー制約を持たないため、参照整合性が保証されない
   - Postのauthor._idが指すUserが存在することを強制する仕組みがない

---

## 5. 技術的詳細

### 5.1 APIの実装 (/api/users/[userId]/follow/route.ts)

```typescript
// 113-119行目
const targetUser = await User.findById(userId);
if (!targetUser) {
  return NextResponse.json(
    { error: 'フォロー対象のユーザーが見つかりません' },
    { status: 404 }
  );
}
```

### 5.2 MongooseのfindByIdの挙動
- `findById()`は文字列をObjectIDに自動変換
- 変換は成功するが、該当するドキュメントが存在しない場合はnullを返す
- これが404エラーの直接的な原因

---

## 6. 影響範囲

### 6.1 影響を受ける機能
- フォローボタンの動作（完全に機能しない）
- ユーザープロフィールへのリンク（存在しないユーザーへのリンクになる可能性）
- フォロー数の集計（不正確になる可能性）

### 6.2 影響を受けるユーザー
- /boardページを閲覧する全ユーザー
- 削除されたユーザーの投稿を見ているユーザー

---

## 7. 推奨される解決策

### 7.1 短期的な対応（緊急修正）

1. **エラーハンドリングの改善**
   - 存在しないユーザーの場合、フォローボタンを非表示にする
   - より分かりやすいエラーメッセージを表示

2. **データクリーンアップ**
   - 存在しないユーザーの投稿を特定し、削除または修正
   - スクリプトで不整合なデータを検出・修正

### 7.2 中長期的な対応（根本解決）

1. **データモデルの改善**
   - PostのauthorフィールドをObjectID参照に変更（populate使用）
   - カスケード削除の実装

2. **データ整合性の保証**
   - ユーザー削除時に関連投稿も削除/無効化
   - 定期的な整合性チェックジョブの実装

3. **テストデータの管理**
   - シーダースクリプトの改善
   - テスト環境のデータリセット機能

---

## 8. 証拠とログ

### 8.1 データベース調査ログ
```
=== エラーで報告されているIDのユーザー存在確認 ===
ID: 68a8182040abde7f4273e6e9
  → 結果: ユーザー存在しない

=== これらのIDを持つ投稿の確認 ===
author._id: 68a8176840abde7f4273e6e9
  → 投稿タイトル: 要求7他人投稿_1755846507235
  → author.name: 掲示板テストユーザー1
```

### 8.2 テスト実行結果
- テストスクリプト: `/scripts/test-follow-error.js`
- 作成した正常データ: ユーザーID `68afac8ef30f58c749a43a4c` → 正常動作確認

---

## 9. 結論

フォローボタンの404エラーは、**Postコレクション内のauthor情報が指すUserが実際には存在しない**というデータ不整合が根本原因です。この問題は、MongoDBの参照整合性の欠如と、ユーザー削除時の関連データ処理の不備によって発生しています。

短期的にはエラーハンドリングの改善とデータクリーンアップで対応し、中長期的にはデータモデルの改善と整合性保証の仕組みを実装することを推奨します。

---

## 署名

**報告作成日時**: 2025年8月28日  
**報告者**: QA Lead #21  
**検証環境**: localhost:3000 (開発環境)  
**MongoDB**: localhost:27017/board-app  

I attest: all numbers and findings come from the attached evidence and actual test execution.