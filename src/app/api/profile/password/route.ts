import type { NextRequest} from 'next/server';
import { NextResponse } from 'next/server';

import { requireEmailVerifiedSession, ApiAuthError, createApiErrorResponse } from '@/lib/api-auth';
import { connectDB } from '@/lib/db/mongodb';
import User from '@/lib/models/User';

// PUT: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
export async function PUT(req: NextRequest) {
  try {
    // ğŸ”’ 25äººå¤©æ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ä¼šè­°ã«ã‚ˆã‚‹ç·Šæ€¥ä¿®æ­£: ãƒ¡ãƒ¼ãƒ«ç¢ºèªæ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³å¿…é ˆ
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¯ç‰¹ã«é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ“ä½œã®ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«ç¢ºèªå¿…é ˆ
    const session = await requireEmailVerifiedSession();

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const body = await req.json();
    const { currentPassword, newPassword } = body;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!currentPassword || !newPassword) {
      return NextResponse.json(
        { error: 'ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' },
        { status: 400 }
      );
    }

    if (typeof currentPassword !== 'string' || typeof newPassword !== 'string') {
      return NextResponse.json(
        { error: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    if (newPassword.length < 8) {
      return NextResponse.json(
        { error: 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™' },
        { status: 400 }
      );
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¤‡é›‘æ€§ãƒã‚§ãƒƒã‚¯
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/;
    if (!passwordRegex.test(newPassword)) {
      return NextResponse.json(
        { error: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤§æ–‡å­—ã€å°æ–‡å­—ã€æ•°å­—ã€ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™' },
        { status: 400 }
      );
    }

    if (currentPassword === newPassword) {
      return NextResponse.json(
        { error: 'æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç•°ãªã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™' },
        { status: 400 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
    await connectDB();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€ï¼‰
    const user = await User.findOne({ email: session.user.email }).select('+password');

    if (!user) {
      return NextResponse.json(
        { error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèª
    const isPasswordValid = await user.comparePassword(currentPassword);
    if (!isPasswordValid) {
      return NextResponse.json(
        { error: 'ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆpre('save')ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§è‡ªå‹•çš„ã«ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚Œã‚‹ï¼‰
    user.password = newPassword;
    user.lastPasswordChange = new Date();
    await user.save();

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¾Œã¯å†ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¿ƒã™
    // ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€å…¨ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ï¼‰

    return NextResponse.json(
      { 
        message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚',
        requireReauth: true 
      },
      { status: 200 }
    );
  } catch (error) {
    // ğŸ”’ APIèªè¨¼ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    if (error instanceof ApiAuthError) {
      return createApiErrorResponse(error);
    }
    
    console.error('Password change error:', error);
    return NextResponse.json(
      { error: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}