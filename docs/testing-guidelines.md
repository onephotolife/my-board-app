# パスワード変更機能テストガイドライン

## 概要
このドキュメントは、パスワード変更機能の包括的なテスト手順とチェックポイントを提供します。

## テストの種類と実行方法

### 1. 単体テスト (Unit Test)

**目的**: 個々のコンポーネントが独立して正しく動作することを確認

**実行コマンド**:
```bash
# 全ての単体テストを実行
npm run test

# 特定のテストファイルを実行
npm run test -- PasswordChangeDialog.test.tsx

# ウォッチモードで実行
npm run test:watch

# カバレッジレポート付きで実行
npm run test:coverage
```

**チェックポイント**:
- [ ] ダイアログコンポーネントが正しくレンダリングされる
- [ ] フォーム入力が正しく処理される
- [ ] バリデーションエラーが適切に表示される
- [ ] パスワード表示/非表示の切り替えが動作する
- [ ] 送信成功時の処理が正しく実行される
- [ ] 送信失敗時のエラーハンドリングが適切
- [ ] キャンセル機能が正しく動作する
- [ ] 送信中の状態管理が適切

### 2. 結合テスト (Integration Test)

**目的**: 複数のコンポーネントが連携して正しく動作することを確認

**実行コマンド**:
```bash
# 結合テストを実行
npm run test -- profile-integration.test.tsx
```

**チェックポイント**:
- [ ] プロフィールページとダイアログの連携が正しい
- [ ] UserContextとの統合が適切
- [ ] 認証状態の管理が正しい
- [ ] APIコールが適切に処理される
- [ ] 状態の更新が正しく反映される
- [ ] エラー状態が適切に処理される

### 3. E2Eテスト (End-to-End Test)

**目的**: 実際のユーザーフローが期待通りに動作することを確認

**実行コマンド**:
```bash
# E2Eテストを実行（ヘッドレス）
npm run test:e2e

# UIモードで実行（デバッグ用）
npm run test:e2e:ui

# ブラウザを表示して実行
npm run test:e2e:headed

# デバッグモードで実行
npm run test:e2e:debug

# テストレポートを表示
npm run test:e2e:report
```

**チェックポイント**:
- [ ] ログイン後にプロフィールページにアクセスできる
- [ ] パスワード変更ボタンでダイアログが開く
- [ ] フォームの入力と送信が正しく動作する
- [ ] 成功/失敗メッセージが適切に表示される
- [ ] ダイアログの開閉が正しく動作する
- [ ] キーボードショートカット（Esc）が動作する
- [ ] 背景クリックでダイアログが閉じる

### 4. Playwrightテスト

**目的**: クロスブラウザでの動作確認

**実行コマンド**:
```bash
# 全ブラウザでテスト
npm run test:e2e

# 特定のブラウザでテスト
npm run test:e2e -- --project=chromium
npm run test:e2e -- --project=firefox
npm run test:e2e -- --project=webkit

# テストコードを生成
npm run test:e2e:codegen
```

**対象ブラウザ**:
- Chromium (Chrome, Edge)
- Firefox
- WebKit (Safari)

## テスト実行の推奨順序

1. **開発中**:
   ```bash
   npm run test:watch  # 単体テストをウォッチモード
   ```

2. **コミット前**:
   ```bash
   npm run test        # 全単体テスト
   npm run lint        # コード品質チェック
   ```

3. **プルリクエスト前**:
   ```bash
   npm run test:coverage  # カバレッジ確認
   npm run test:e2e       # E2Eテスト
   ```

4. **リリース前**:
   ```bash
   npm run test:e2e:ci    # CI環境でのE2Eテスト
   ```

## 手動テストチェックリスト

### 基本機能
- [ ] パスワード変更ボタンをクリックするとダイアログが開く
- [ ] ダイアログ内のフォームフィールドが表示される
- [ ] パスワード入力フィールドが3つ表示される
- [ ] パスワード表示/非表示ボタンが動作する

### バリデーション
- [ ] 空のフォームを送信するとエラーが表示される
- [ ] 短すぎるパスワード（8文字未満）でエラーが表示される
- [ ] パスワード不一致でエラーが表示される
- [ ] 現在のパスワードと同じ新パスワードでエラーが表示される

### ユーザビリティ
- [ ] タブキーでフィールド間を移動できる
- [ ] Enterキーでフォームを送信できる
- [ ] Escキーでダイアログを閉じられる
- [ ] 背景クリックでダイアログを閉じられる
- [ ] 送信中はフォームが無効化される
- [ ] 成功/失敗メッセージが適切に表示される

### アクセシビリティ
- [ ] スクリーンリーダーで適切に読み上げられる
- [ ] キーボードのみで操作可能
- [ ] フォーカス管理が適切
- [ ] aria-labelが適切に設定されている

### パフォーマンス
- [ ] ダイアログの開閉がスムーズ
- [ ] フォーム入力に遅延がない
- [ ] API応答が適切な時間内に返される

## トラブルシューティング

### よくある問題と解決方法

1. **aria-hidden エラー**
   - 原因: MUIダイアログのフォーカス管理の問題
   - 解決: Portalを使用し、適切なaria属性を設定

2. **ダイアログが自動的に閉じる**
   - 原因: イベントバブリングの問題
   - 解決: stopPropagationを適切に使用

3. **テストが失敗する**
   - モックが正しく設定されているか確認
   - 非同期処理にwaitForを使用しているか確認
   - テスト環境の設定を確認

## CI/CD統合

### GitHub Actions設定例
```yaml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run test:coverage
      - run: npm run test:e2e:ci
```

## カバレッジ目標

- 単体テスト: 80%以上
- 結合テスト: 70%以上
- E2Eテスト: 主要なユーザーフローをカバー

## 継続的改善

1. テスト実行時間の監視
2. フレイキーテストの特定と修正
3. カバレッジの定期的な見直し
4. 新機能追加時のテスト追加