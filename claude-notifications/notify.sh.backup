#!/bin/bash

# Claude Code Notification System
# MacéŸ³å£°ã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆiPhone/Slack/Discord/Chatworkï¼‰å¯¾å¿œ

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
CONFIG_FILE="$HOME/.claude-notifications-config"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
DEFAULT_SOUND="Glass"  # Macé€šçŸ¥éŸ³
DEFAULT_VOLUME=50      # éŸ³é‡ï¼ˆ0-100ï¼‰

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯èª­ã¿è¾¼ã¿
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# å¼•æ•°å‡¦ç†
NOTIFICATION_TYPE="$1"  # "input_waiting" ã¾ãŸã¯ "response_complete"
MESSAGE="$2"            # é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
TITLE="$3"              # é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
if [ -z "$TITLE" ]; then
    if [ "$NOTIFICATION_TYPE" = "input_waiting" ]; then
        TITLE="â³ Claude Code - å…¥åŠ›å¾…ã¡"
    elif [ "$NOTIFICATION_TYPE" = "response_complete" ]; then
        TITLE="âœ… Claude Code - å¿œç­”å®Œäº†"
    else
        TITLE="ğŸ”” Claude Code"
    fi
fi

if [ -z "$MESSAGE" ]; then
    if [ "$NOTIFICATION_TYPE" = "input_waiting" ]; then
        MESSAGE="ClaudeãŒã‚ãªãŸã®å…¥åŠ›ã‚’å¾…ã£ã¦ã„ã¾ã™"
    elif [ "$NOTIFICATION_TYPE" = "response_complete" ]; then
        MESSAGE="Claudeã®å¿œç­”ãŒå®Œäº†ã—ã¾ã—ãŸ"
    else
        MESSAGE="é€šçŸ¥"
    fi
fi

# é€šçŸ¥ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ç•°ãªã‚‹éŸ³ã‚’è¨­å®š
case "$NOTIFICATION_TYPE" in
    "input_waiting")
        SOUND="${INPUT_SOUND:-Ping}"
        ;;
    "response_complete")
        SOUND="${COMPLETE_SOUND:-Glass}"
        ;;
    *)
        SOUND="${DEFAULT_SOUND}"
        ;;
esac

# ============================================
# 1. Mac ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥
# ============================================
send_mac_notification() {
    # æ–¹æ³•1: é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼çµŒç”±ï¼ˆå¾“æ¥ã®é€šçŸ¥ï¼‰
    osascript <<EOF
display notification "$MESSAGE" with title "$TITLE" sound name "$SOUND"
EOF
    
    # æ–¹æ³•2: ç”»é¢ä¸Šã«ç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹é€šçŸ¥ï¼ˆè¤‡æ•°æ‰‹æ³•ï¼‰
    if [ "${FRONTEND_ALERT:-true}" = "true" ]; then
        local icon=""
        case "$NOTIFICATION_TYPE" in
            "input_waiting")
                icon="â³"
                ;;
            "response_complete")
                icon="âœ…"
                ;;
            *)
                icon="ğŸ””"
                ;;
        esac
        
        # å³ä¸Šé€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼é€šçŸ¥ï¼ˆterminal-notifierä½¿ç”¨ï¼‰
        if command -v terminal-notifier >/dev/null 2>&1; then
            # terminal-notifierã§å³ä¸Šã«ç¢ºå®Ÿã«è¡¨ç¤º
            terminal-notifier -title "$icon $TITLE" -message "$MESSAGE" -sound "$SOUND" &
        fi
        
        # macOSæ¨™æº–é€šçŸ¥ï¼ˆSystem EventsçµŒç”±ï¼‰ã‚‚è¿½åŠ ã§å®Ÿè¡Œ
        osascript <<EOF &
try
    tell application "System Events"
        display notification "$MESSAGE" with title "$icon $TITLE" sound name "$SOUND"
    end tell
end try
EOF
    fi
    
    # æ–¹æ³•3: éŸ³ã®å†ç”Ÿï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    if [ "${FORCE_SOUND:-true}" = "true" ]; then
        # macOSã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã‚µã‚¦ãƒ³ãƒ‰ã‚’å†ç”Ÿ
        case "$SOUND" in
            "Glass"|"Ping"|"Pop"|"Purr"|"Tink")
                afplay "/System/Library/Sounds/${SOUND}.aiff" 2>/dev/null &
                ;;
            "Basso"|"Blow"|"Bottle"|"Frog"|"Funk"|"Hero"|"Morse"|"Sosumi"|"Submarine")
                afplay "/System/Library/Sounds/${SOUND}.aiff" 2>/dev/null &
                ;;
            *)
                # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ“ãƒ¼ãƒ—éŸ³
                osascript -e "beep" 2>/dev/null &
                ;;
        esac
    fi
}

# ============================================
# 2. iPhoneé€šçŸ¥ï¼ˆPushoverçµŒç”±ï¼‰
# ============================================
send_iphone_notification() {
    if [ -n "$PUSHOVER_USER_KEY" ] && [ -n "$PUSHOVER_APP_TOKEN" ]; then
        curl -s -X POST "https://api.pushover.net/1/messages.json" \
            -d "token=$PUSHOVER_APP_TOKEN" \
            -d "user=$PUSHOVER_USER_KEY" \
            -d "title=$TITLE" \
            -d "message=$MESSAGE" \
            -d "sound=${PUSHOVER_SOUND:-pushover}" \
            -d "priority=${PUSHOVER_PRIORITY:-0}" \
            > /dev/null 2>&1
    fi
}

# ============================================
# 3. Slacké€šçŸ¥
# ============================================
send_slack_notification() {
    if [ -n "$SLACK_WEBHOOK_URL" ]; then
        local emoji=""
        case "$NOTIFICATION_TYPE" in
            "input_waiting")
                emoji=":hourglass_flowing_sand:"
                ;;
            "response_complete")
                emoji=":white_check_mark:"
                ;;
            *)
                emoji=":bell:"
                ;;
        esac
        
        curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
                \"text\": \"$TITLE\",
                \"attachments\": [{
                    \"text\": \"$MESSAGE\",
                    \"color\": \"${SLACK_COLOR:-#0084FF}\",
                    \"footer\": \"Claude Code\",
                    \"footer_icon\": \"https://www.anthropic.com/favicon.ico\",
                    \"ts\": $(date +%s)
                }],
                \"icon_emoji\": \"$emoji\"
            }" > /dev/null 2>&1
    fi
}

# ============================================
# 4. Discordé€šçŸ¥
# ============================================
send_discord_notification() {
    if [ -n "$DISCORD_WEBHOOK_URL" ]; then
        local color=""
        case "$NOTIFICATION_TYPE" in
            "input_waiting")
                color="16776960"  # Yellow
                ;;
            "response_complete")
                color="65280"     # Green
                ;;
            *)
                color="3447003"   # Blue
                ;;
        esac
        
        curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
                \"username\": \"Claude Code\",
                \"avatar_url\": \"https://www.anthropic.com/favicon.ico\",
                \"embeds\": [{
                    \"title\": \"$TITLE\",
                    \"description\": \"$MESSAGE\",
                    \"color\": $color,
                    \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\",
                    \"footer\": {
                        \"text\": \"Claude Code Notification\"
                    }
                }]
            }" > /dev/null 2>&1
    fi
}

# ============================================
# 5. LINE Notifyé€šçŸ¥
# ============================================
send_line_notification() {
    if [ -n "$LINE_NOTIFY_TOKEN" ]; then
        local emoji=""
        case "$NOTIFICATION_TYPE" in
            "input_waiting")
                emoji="â³"
                ;;
            "response_complete")
                emoji="âœ…"
                ;;
            *)
                emoji="ğŸ””"
                ;;
        esac
        
        curl -s -X POST "https://notify-api.line.me/api/notify" \
            -H "Authorization: Bearer $LINE_NOTIFY_TOKEN" \
            -d "message=$emoji $TITLE%0A$MESSAGE" > /dev/null 2>&1
    fi
}

# ============================================
# 6. Chatworké€šçŸ¥
# ============================================
send_chatwork_notification() {
    if [ -n "$CHATWORK_API_TOKEN" ] && [ -n "$CHATWORK_ROOM_ID" ]; then
        local icon=""
        case "$NOTIFICATION_TYPE" in
            "input_waiting")
                icon="[info]"
                ;;
            "response_complete")
                icon="[info]"
                ;;
            *)
                icon="[info]"
                ;;
        esac
        
        curl -s -X POST "https://api.chatwork.com/v2/rooms/$CHATWORK_ROOM_ID/messages" \
            -H "X-ChatWorkToken: $CHATWORK_API_TOKEN" \
            -d "body=$icon $TITLE%0A$MESSAGE" > /dev/null 2>&1
    fi
}

# ============================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ============================================

# Macé€šçŸ¥ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
send_mac_notification

# å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€šçŸ¥ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
if [ "${ENABLE_IPHONE:-false}" = "true" ]; then
    send_iphone_notification &
fi

if [ "${ENABLE_SLACK:-false}" = "true" ]; then
    send_slack_notification &
fi

if [ "${ENABLE_DISCORD:-false}" = "true" ]; then
    send_discord_notification &
fi

if [ "${ENABLE_CHATWORK:-false}" = "true" ]; then
    send_chatwork_notification &
fi

# ã™ã¹ã¦ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
wait

exit 0