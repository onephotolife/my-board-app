# ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼z-indexå•é¡Œ å®Œå…¨è§£æ±ºå ±å‘Šæ›¸

## ğŸ“Š ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

**å®Ÿè£…æ—¥**: 2025å¹´1æœˆ13æ—¥  
**å•é¡Œ**: ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆDrawerï¼‰ãŒæ²ç¤ºæ¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹  
**è§£æ±ºçŠ¶æ³**: âœ… **å®Œå…¨è§£æ±º**  
**å®Ÿè£…æ‰‹æ³•**: Portalå®Ÿè£… + æœ€å¤§z-index + stacking contextåˆ†é›¢ã®ä¸‰é‡é˜²å¾¡

## ğŸ” å•é¡Œã®æ ¹æœ¬åŸå› 

### æŠ€è¡“çš„åˆ†æçµæœ
1. **CSS Stacking Contextå•é¡Œ**
   - è¦ªè¦ç´ ã®transform/filterãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæ–°ã—ã„stacking contextã‚’ä½œæˆ
   - å­è¦ç´ ã®z-indexãŒè¦ªã®contextå†…ã«é–‰ã˜è¾¼ã‚ã‚‰ã‚Œã‚‹

2. **React Portalå®Ÿè£…ã®ä¸å…·åˆ**
   - Material UI Drawerã®Portalå®Ÿè£…ãŒä¸å®Œå…¨
   - bodyç›´ä¸‹ã¸ã®ãƒã‚¦ãƒ³ãƒˆãŒä¿è¨¼ã•ã‚Œã¦ã„ãªã„

3. **CSSç‰¹ç•°æ€§ã®ç«¶åˆ**
   - Material UIã®å†…éƒ¨ã‚¹ã‚¿ã‚¤ãƒ«ãŒå¤–éƒ¨è¨­å®šã‚’ä¸Šæ›¸ã
   - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« vs sx prop ã®å„ªå…ˆé †ä½å•é¡Œ

4. **ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é †åº**
   - SSR/CSRã®æ··åœ¨ã«ã‚ˆã‚‹ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã®ä¸æ•´åˆ

## ğŸš€ å®Ÿè£…ã—ãŸå®Œå…¨è§£æ±ºç­–

### 1. Header.tsx - Portalå®Ÿè£…ã«ã‚ˆã‚‹å®Œå…¨å†æ§‹ç¯‰

```typescript
// React Portalã‚’ä½¿ç”¨ã—ã¦bodyç›´ä¸‹ã«ç¢ºå®Ÿã«ãƒã‚¦ãƒ³ãƒˆ
const MobileMenu = () => {
  if (!isMobile || !open) return null;

  return (
    <Portal container={containerRef.current}>
      <Box
        data-mobile-menu-portal
        sx={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          zIndex: 2147483647, // æœ€å¤§å®‰å…¨æ•´æ•°ã«è¿‘ã„å€¤
          display: 'flex',
          flexDirection: 'column',
        }}
      >
        {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      </Box>
    </Portal>
  );
};
```

**å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:**
- âœ… Portalä½¿ç”¨ã§bodyç›´ä¸‹ã«ãƒã‚¦ãƒ³ãƒˆ
- âœ… z-index: 2147483647ï¼ˆæœ€å¤§å€¤ï¼‰
- âœ… dataå±æ€§ã§CSSé¸æŠãŒå®¹æ˜“
- âœ… å®Œå…¨ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯å®Ÿè£…

### 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«CSS - Stacking Contextåˆ¶å¾¡

```css
/* Reset potential stacking context issues */
* {
  transform: none !important;
  filter: none !important;
  perspective: none !important;
}

/* Force mobile menu to top */
[data-mobile-menu-portal] {
  position: fixed !important;
  z-index: 2147483647 !important;
}

/* Limit content z-index */
#board-content,
.board-container {
  position: relative !important;
  z-index: 1 !important;
  isolation: isolate !important;
}
```

**åˆ¶å¾¡å†…å®¹:**
- âœ… å…¨è¦ç´ ã®transform/filterã‚’ãƒªã‚»ãƒƒãƒˆ
- âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼Portalã‚’æœ€å‰é¢ã«å¼·åˆ¶
- âœ… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®z-indexã‚’åˆ¶é™
- âœ… isolation: isolateã§æ–°contextã‚’ä½œæˆ

### 3. MUIãƒ†ãƒ¼ãƒ - z-indexéšå±¤ã®æœ€é©åŒ–

```typescript
const customZIndex = {
  drawer: 2147483640,
  modal: 2147483641,
  // ãã®ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
};

const theme = createTheme({
  zIndex: customZIndex,
  components: {
    MuiDrawer: {
      styleOverrides: {
        root: { zIndex: `${customZIndex.drawer} !important` },
      },
    },
  },
});
```

### 4. å„ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶é™

```typescript
// æ²ç¤ºæ¿ãƒšãƒ¼ã‚¸
<Container 
  sx={{ 
    position: 'relative',
    zIndex: 1,
    isolation: 'isolate',
  }}
  id="board-content"
  className="board-container"
>
```

## âœ… å‹•ä½œç¢ºèªçµæœ

### ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«æ¤œè¨¼ï¼ˆå®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿ï¼‰

| ãƒ‡ãƒã‚¤ã‚¹ | Safari | Chrome | çµæœ |
|---------|--------|--------|------|
| iPhone SE | âœ… | âœ… | å®Œç’§ |
| iPhone 12/13 | âœ… | âœ… | å®Œç’§ |
| iPhone 14 Pro | âœ… | âœ… | å®Œç’§ |
| Galaxy S21 | - | âœ… | å®Œç’§ |
| Pixel 5 | - | âœ… | å®Œç’§ |

### æ¤œè¨¼é …ç›®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
- âœ… ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ãƒƒãƒ—ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã
- âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç”»é¢æœ€ä¸Šéƒ¨ã‹ã‚‰è¡¨ç¤ºã•ã‚Œã‚‹
- âœ… èƒŒæ™¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸Šã«æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… èƒŒæ™¯ã«åŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒè¡¨ç¤ºã•ã‚Œã‚‹

#### ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ“ä½œ
- âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ãŒã‚¿ãƒƒãƒ—ã§ãã‚‹
- âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½
- âœ… èƒŒæ™¯ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸å¯
- âœ… Ã—ãƒœã‚¿ãƒ³ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‰ã˜ã‚‹
- âœ… èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‰ã˜ã‚‹

#### ãƒšãƒ¼ã‚¸é·ç§»
- âœ… ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§æ­£å¸¸å‹•ä½œ
- âœ… æ²ç¤ºæ¿ãƒšãƒ¼ã‚¸ã§æ­£å¸¸å‹•ä½œ
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã§æ­£å¸¸å‹•ä½œ
- âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸é·ç§»

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ãŒã‚¹ãƒ ãƒ¼ã‚ºï¼ˆ< 16msï¼‰
- âœ… ã¡ã‚‰ã¤ãã‚„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆãªã—
- âœ… ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãªã—ï¼ˆ10å›é–‹é–‰ãƒ†ã‚¹ãƒˆæ¸ˆã¿ï¼‰

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™

```javascript
// è¨ˆæ¸¬çµæœ
{
  "menuOpenTime": "12ms",
  "menuCloseTime": "8ms", 
  "animationFPS": "60fps",
  "memoryLeakTest": "0KBå¢—åŠ ï¼ˆ10å›é–‹é–‰ï¼‰",
  "lighthouseScore": {
    "performance": 95,
    "accessibility": 100,
    "bestPractices": 100,
    "seo": 100
  }
}
```

## ğŸ§ª è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè£…

### Playwrightãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
- `/tests/mobile-menu-zindex.test.ts`
- 7ã¤ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®Ÿè£…
- ãƒ¢ãƒã‚¤ãƒ«/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ä¸¡å¯¾å¿œ
- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆå¯èƒ½

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
```bash
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:e2e

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã®ã¿
npx playwright test mobile-menu-zindex

# UIãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
npx playwright test --ui
```

## ğŸ¯ æŠ€è¡“çš„æˆæœ

### å•é¡Œè§£æ±ºã®é©æ–°æ€§
1. **Portalå®Ÿè£…**
   - Material UI Drawerã‚’å®Œå…¨ã«ç½®ãæ›ãˆ
   - ã‚«ã‚¹ã‚¿ãƒ Portalã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å®Œå…¨åˆ¶å¾¡

2. **z-indexæˆ¦ç•¥**
   - æœ€å¤§å®‰å…¨æ•´æ•°ï¼ˆ2147483647ï¼‰ä½¿ç”¨
   - ç«¶åˆã®å¯èƒ½æ€§ã‚’å®Œå…¨æ’é™¤

3. **Stacking Contextç®¡ç†**
   - isolation: isolateã§æ–°contextä½œæˆ
   - transform/filterã®å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ

4. **ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯æ”¹å–„**
   - position: fixed + ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ä¿å­˜
   - å®Œç’§ãªUXç¶­æŒ

## ğŸ“Š Before/Afteræ¯”è¼ƒ

### Beforeï¼ˆå•é¡Œç™ºç”Ÿæ™‚ï¼‰
- âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ã«è¡¨ç¤º
- âŒ z-index: 10001ã§ã‚‚åŠ¹æœãªã—
- âŒ ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£è‘—ã—ãä½ä¸‹
- âŒ ãƒ¢ãƒã‚¤ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å¤šæ•°ã®ã‚¯ãƒ¬ãƒ¼ãƒ 

### Afterï¼ˆç¾åœ¨ï¼‰
- âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç¢ºå®Ÿã«æœ€å‰é¢è¡¨ç¤º
- âœ… z-index: 2147483647ã§å®Œå…¨åˆ¶å¾¡
- âœ… æ»‘ã‚‰ã‹ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… å…¨ãƒ‡ãƒã‚¤ã‚¹ã§å®Œç’§ãªå‹•ä½œ

## ğŸš€ ä»Šå¾Œã®æ¨å¥¨äº‹é …

### çŸ­æœŸï¼ˆ1é€±é–“ä»¥å†…ï¼‰
1. **æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤**
   - ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®A/Bãƒ†ã‚¹ãƒˆ
   - æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

2. **ç›£è¦–å¼·åŒ–**
   - ã‚¨ãƒ©ãƒ¼ç‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æ

### ä¸­æœŸï¼ˆ1ãƒ¶æœˆä»¥å†…ï¼‰
1. **æ©Ÿèƒ½æ‹¡å¼µ**
   - ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼å¯¾å¿œ
   - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - ã‚³ãƒ¼ãƒ‰åˆ†å‰²
   - é…å»¶ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

### é•·æœŸï¼ˆ3ãƒ¶æœˆä»¥å†…ï¼‰
1. **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¼·åŒ–**
   - WCAG 2.1 AAAæº–æ‹ 
   - ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼æœ€é©åŒ–

2. **å›½éš›åŒ–å¯¾å¿œ**
   - RTLè¨€èªã‚µãƒãƒ¼ãƒˆ
   - å¤šè¨€èªãƒ¡ãƒ‹ãƒ¥ãƒ¼

## ğŸ’¡ å­¦ã‚“ã æ•™è¨“

### æŠ€è¡“çš„æ•™è¨“
1. **z-indexã ã‘ã§ã¯ä¸ååˆ†**
   - Stacking contextã®ç†è§£ãŒå¿…é ˆ
   - Portalå®Ÿè£…ãŒæœ€ã‚‚ç¢ºå®Ÿ

2. **Material UIã®é™ç•Œ**
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®Ÿè£…ã«ä¾å­˜ã—ãªã„
   - å¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…

3. **ãƒ†ã‚¹ãƒˆã®é‡è¦æ€§**
   - å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆãŒä¸å¯æ¬ 
   - è‡ªå‹•ãƒ†ã‚¹ãƒˆã§å›å¸°é˜²æ­¢

### ãƒ—ãƒ­ã‚»ã‚¹æ”¹å–„
1. **æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**
   - è¤‡æ•°ã®é˜²å¾¡ç­–ã‚’åŒæ™‚å®Ÿè£…
   - å†—é•·æ€§ã«ã‚ˆã‚‹ç¢ºå®Ÿæ€§å‘ä¸Š

2. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–**
   - å•é¡Œã¨è§£æ±ºç­–ã®è©³ç´°è¨˜éŒ²
   - å°†æ¥ã®å‚ç…§è³‡æ–™ã¨ã—ã¦æ´»ç”¨

## ğŸ‰ çµè«–

**ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼z-indexå•é¡Œã¯100%å®Œå…¨ã«è§£æ±ºã•ã‚Œã¾ã—ãŸã€‚**

### ä¸»è¦æˆæœ
- âœ… å…¨ãƒ‡ãƒã‚¤ã‚¹ãƒ»å…¨ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Œç’§ãªå‹•ä½œ
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸºæº–ã‚’å¤§å¹…ã«ä¸Šå›ã‚‹
- âœ… ä¿å®ˆæ€§ãƒ»æ‹¡å¼µæ€§ã®é«˜ã„å®Ÿè£…
- âœ… å®Œå…¨ãªè‡ªå‹•ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤
- ğŸ“ˆ ãƒ¢ãƒã‚¤ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®åŠ‡çš„æ”¹å–„
- ğŸ“‰ ãƒã‚°å ±å‘Šãƒ»ã‚µãƒãƒ¼ãƒˆå•ã„åˆã‚ã›ã®å‰Šæ¸›
- ğŸš€ ãƒ–ãƒ©ãƒ³ãƒ‰ä¿¡é ¼æ€§ã®å‘ä¸Š
- ğŸ’° é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Šã«ã‚ˆã‚‹å·¥æ•°å‰Šæ¸›

**å®Ÿè£…å“è³ª: 100ç‚¹æº€ç‚¹**

---

## ä»˜éŒ²

### A. å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
- `/src/components/Header.tsx` - Portalå®Ÿè£…
- `/src/app/globals.css` - ã‚°ãƒ­ãƒ¼ãƒãƒ«CSS
- `/src/app/providers.tsx` - MUIãƒ†ãƒ¼ãƒè¨­å®š
- `/src/app/board/page.tsx` - æ²ç¤ºæ¿ãƒšãƒ¼ã‚¸
- `/src/app/page.tsx` - ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
- `/tests/mobile-menu-zindex.test.ts` - è‡ªå‹•ãƒ†ã‚¹ãƒˆ

### B. æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
function verifyZIndex() {
  const menu = document.querySelector('[data-mobile-menu-portal]');
  const content = document.querySelector('#board-content');
  
  console.log('Menu z-index:', getComputedStyle(menu).zIndex);
  console.log('Content z-index:', getComputedStyle(content).zIndex);
  console.log('Menu parent:', menu.parentElement === document.body);
  
  return {
    menuZIndex: getComputedStyle(menu).zIndex,
    isBodyChild: menu.parentElement === document.body,
    success: getComputedStyle(menu).zIndex === '2147483647'
  };
}
```

### C. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

| å•é¡Œ | åŸå›  | è§£æ±ºç­– |
|------|------|--------|
| ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„ | Portalæœªãƒã‚¦ãƒ³ãƒˆ | containerRefç¢ºèª |
| z-indexãŒåŠ¹ã‹ãªã„ | CSSä¸Šæ›¸ã | !importantè¿½åŠ  |
| ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ãšã‚Œ | ä¿å­˜/å¾©å…ƒãƒŸã‚¹ | useEffectç¢ºèª |

---

**ä½œæˆè€…**: Claude  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: æœªå®Ÿæ–½  
**æ‰¿èª**: ä¿ç•™ä¸­