# ãƒ•ã‚©ãƒ­ãƒ¼æ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼åŸå› ç©¶æ˜ãƒ¬ãƒãƒ¼ãƒˆ

## ä½œæˆæ—¥æ™‚
2025å¹´8æœˆ26æ—¥

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼
http://localhost:3000/test-follow ã§ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç™ºç”Ÿã™ã‚‹500ã‚¨ãƒ©ãƒ¼ã¨429ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã—ã¾ã—ãŸã€‚2ã¤ã®ä¸»è¦ãªå•é¡ŒãŒã‚ã‚Šã€ã©ã¡ã‚‰ã‚‚ã‚³ãƒ¼ãƒ‰ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚

---

## 1. å•é¡Œã®è©³ç´°

### 1.1 å ±å‘Šã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼

| ã‚¨ãƒ©ãƒ¼ | ç™ºç”Ÿç®‡æ‰€ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | é »åº¦ |
|--------|---------|--------------|------|
| Internal Server Error | `/api/follow/test-user-3` | 500 | å¸¸ã«ç™ºç”Ÿ |
| Internal Server Error | `/api/follow/test-user-4` | 500 | å¸¸ã«ç™ºç”Ÿ |
| Too Many Requests | `/api/follow/test-user-5` | 429 | å¤šæ•°ã®ã‚¯ãƒªãƒƒã‚¯å¾Œ |
| WebSocket connection error | Socket.ioæ¥ç¶š | - | å‰¯æ¬¡çš„ |

### 1.2 ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç’°å¢ƒ
- **URL**: http://localhost:3000/test-follow
- **è©²å½“ãƒœã‚¿ãƒ³**: ã‚µã‚¤ã‚ºãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒœã‚¿ãƒ³ï¼ˆSmall, Medium, Largeï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `/src/app/test-follow/page.tsx` è¡Œ126-136

---

## 2. æ ¹æœ¬åŸå› åˆ†æ

### åŸå› 1: Next.js 15ã®å‹•çš„ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿éåŒæœŸåŒ– ã€é‡è¦åº¦: é«˜ã€‘

#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Error: Route "/api/follow/[userId]" used `params.userId`. 
`params` should be awaited before using its properties.
```

#### è©³ç´°
- **å½±éŸ¿ãƒ•ã‚¡ã‚¤ãƒ«**: `/src/app/api/follow/[userId]/route.ts`
- **å•é¡Œç®‡æ‰€**: 
  - è¡Œ20: `{ params }: { params: { userId: string } }`
  - è¡Œ50, 61, 150, 180, 210, 288: `params.userId` ã®ç›´æ¥ä½¿ç”¨

#### æŠ€è¡“çš„èƒŒæ™¯
Next.js 15ã‹ã‚‰å‹•çš„ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆparamsï¼‰ãŒéåŒæœŸã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã¯ä»¥ä¸‹ã®ç†ç”±ã«ã‚ˆã‚Šã¾ã™ï¼š
1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
2. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯¾å¿œ
3. ä¸¦åˆ—ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã®æ”¹å–„

**è¨¼æ‹ **: 
- ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°: `/api/follow/test-user-1 500 in 1871ms`
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°: `Error: Route "/api/follow/[userId]" used params.userId`

---

### åŸå› 2: ç„¡åŠ¹ãªMongoDBObjectIDã®ä½¿ç”¨ ã€é‡è¦åº¦: é«˜ã€‘

#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Follow error: CastError: Cast to ObjectId failed for value "test-user-3" (type string) at path "_id" for model "User"
reason: BSONError: input must be a 24 character hex string, 12 byte Uint8Array, or an integer
```

#### è©³ç´°
- **å•é¡Œã®userID**:
  - `test-user-1` (11æ–‡å­—)
  - `test-user-3` (11æ–‡å­—)  
  - `test-user-4` (11æ–‡å­—)
  - `test-user-5` (11æ–‡å­—)

- **MongoDBã®ObjectIDè¦ä»¶**:
  - 24æ–‡å­—ã®16é€²æ•°æ–‡å­—åˆ—
  - ä¾‹: `68ad36cbfd831a5fbd96b575`

#### ã‚³ãƒ¼ãƒ‰ã®å•é¡Œç®‡æ‰€
```javascript
// /src/app/test-follow/page.tsx è¡Œ126-136
<FollowButton 
  userId="test-user-3"  // âŒ ç„¡åŠ¹ãªObjectID
  size="small"
/>
```

**è¨¼æ‹ **:
- ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°: `CastError: Cast to ObjectId failed for value "test-user-3"`
- MongoDBä»•æ§˜: BSONErrorç™ºç”Ÿ

---

### åŸå› 3: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å‹•ä½œ ã€é‡è¦åº¦: ä¸­ã€‘

#### è¨­å®š
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `/src/lib/security/rate-limiter-v2.ts`
- **åˆ¶é™**: 1åˆ†é–“ã«30ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
- **é©ç”¨ç®‡æ‰€**: `/src/middleware.ts` è¡Œ97-112

#### ç™ºç”Ÿãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
1. è¤‡æ•°ã®ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
2. CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚‚å«ã‚ã¦ã‚«ã‚¦ãƒ³ãƒˆ
3. åˆ¶é™å€¤ï¼ˆ30ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ†ï¼‰ã«åˆ°é”
4. 429ã‚¨ãƒ©ãƒ¼è¿”å´

**è¨¼æ‹ **:
- ãƒ†ã‚¹ãƒˆãƒ­ã‚°: `ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«ãƒ’ãƒƒãƒˆï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ#11ï¼‰`  
- ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°: `Rate limit exceeded: ::1 - /api/follow/000000000000000000000000`

---

## 3. å½±éŸ¿ç¯„å›²

### 3.1 å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½±éŸ¿åº¦ | ç†ç”± |
|--------------|--------|------|
| `/api/follow/[userId]/route.ts` | è‡´å‘½çš„ | å…¨ãƒ•ã‚©ãƒ­ãƒ¼æ“ä½œãŒå¤±æ•— |
| `/test-follow/page.tsx` | é«˜ | ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒæ©Ÿèƒ½ã—ãªã„ |
| `FollowButton.tsx` | ä¸­ | ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¯æ­£å¸¸ã ãŒã€APIãŒå¤±æ•— |

### 3.2 ä»–ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
åŒæ§˜ã®å•é¡Œã‚’æŒã¤å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼š
- `/api/posts/[id]/route.ts`
- `/api/users/[id]/route.ts`
- ãã®ä»–ã®å‹•çš„ãƒ«ãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹API

---

## 4. æ¤œè¨¼çµæœ

### 4.1 å†ç¾ãƒ†ã‚¹ãƒˆ

#### ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œçµæœ
```javascript
// test-follow-errors.js å®Ÿè¡Œçµæœ
=== ãƒ†ã‚¹ãƒˆ1: ç„¡åŠ¹ãªUserID ===
  test-user-1: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 500
  test-user-3: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 500
  test-user-4: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ 500

=== ãƒ†ã‚¹ãƒˆ3: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ ===
  ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«ãƒ’ãƒƒãƒˆï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ#11ï¼‰
    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: Too many requests. Please try again later.
```

### 4.2 ãƒ­ã‚°åˆ†æ
```
[æ™‚ç³»åˆ—]
1. params.userIdä½¿ç”¨è­¦å‘Š
2. CastErrorç™ºç”Ÿ
3. 500ã‚¨ãƒ©ãƒ¼è¿”å´
4. è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¾Œ429ã‚¨ãƒ©ãƒ¼
```

---

## 5. ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€ï¼ˆå®Ÿè£…ã›ãšï¼‰

### 5.1 Next.js 15å¯¾å¿œ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `/src/app/api/follow/[userId]/route.ts`

ä¿®æ­£å‰:
```typescript
export async function POST(
  req: NextRequest,
  { params }: { params: { userId: string } }
) {
  // ...
  if (currentUser._id.toString() === params.userId) {
```

ä¿®æ­£å¾Œï¼ˆæ¡ˆï¼‰:
```typescript
export async function POST(
  req: NextRequest,
  { params }: { params: Promise<{ userId: string }> }
) {
  const { userId } = await params;
  // ...
  if (currentUser._id.toString() === userId) {
```

### 5.2 ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã®userIDä¿®æ­£
**ãƒ•ã‚¡ã‚¤ãƒ«**: `/src/app/test-follow/page.tsx`

ä¿®æ­£å‰:
```javascript
<FollowButton userId="test-user-3" size="small" />
```

ä¿®æ­£å¾Œï¼ˆæ¡ˆï¼‰:
```javascript
// å®Ÿéš›ã®MongoDBãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä½¿ç”¨
<FollowButton userId="68ad36cbfd831a5fbd96b575" size="small" />
```

---

## 6. æ¨å¥¨äº‹é …ï¼ˆå®Ÿè£…ãªã—ï¼‰

### 6.1 å³åº§ã«å¯¾å¿œã™ã¹ãäº‹é …
1. **Next.js 15äº’æ›æ€§å¯¾å¿œ**
   - ã™ã¹ã¦ã®å‹•çš„ãƒ«ãƒ¼ãƒˆAPIã‚’ç¢ºèª
   - `params`ã‚’`await`ã§å‡¦ç†ã™ã‚‹ã‚ˆã†ä¿®æ­£

2. **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ”¹å–„**
   - æœ‰åŠ¹ãªObjectIDã‚’ä½¿ç”¨
   - ã¾ãŸã¯ãƒ¢ãƒƒã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’äº‹å‰ä½œæˆ

### 6.2 ä¸­æœŸçš„æ”¹å–„
1. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–**
   - ObjectIDå½¢å¼ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„

2. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®èª¿æ•´**
   - é–‹ç™ºç’°å¢ƒã§ã¯ç·©å’Œ
   - `/api/follow`å°‚ç”¨ã®åˆ¶é™è¨­å®šè¿½åŠ 

3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±æä¾›
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

---

## 7. ãƒªã‚¹ã‚¯è©•ä¾¡

| ãƒªã‚¹ã‚¯ | å¯èƒ½æ€§ | å½±éŸ¿åº¦ | å¯¾ç­–å„ªå…ˆåº¦ |
|--------|--------|--------|-----------|
| æœ¬ç•ªç’°å¢ƒã§ã®500ã‚¨ãƒ©ãƒ¼ | é«˜ | è‡´å‘½çš„ | æœ€å„ªå…ˆ |
| ä»–ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ | é«˜ | é«˜ | é«˜ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ä½ä¸‹ | ç¢ºå®Ÿ | é«˜ | é«˜ |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«ã‚ˆã‚‹æ­£å½“ãªä½¿ç”¨ã®é˜»å®³ | ä¸­ | ä¸­ | ä¸­ |

---

## 8. çµè«–

### 8.1 ä¸»è¦ãªç™ºè¦‹
1. **Next.js 15ã®ç ´å£Šçš„å¤‰æ›´**ã¸ã®æœªå¯¾å¿œãŒ500ã‚¨ãƒ©ãƒ¼ã®ä¸»å› 
2. **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¸å‚™**ï¼ˆç„¡åŠ¹ãªObjectIDä½¿ç”¨ï¼‰ãŒå•é¡Œã‚’é¡•åœ¨åŒ–
3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ãŒã€è¨­å®šã®æœ€é©åŒ–ãŒå¿…è¦

### 8.2 å„ªå…ˆé †ä½
1. ğŸ”´ **æœ€å„ªå…ˆ**: Next.js 15å¯¾å¿œï¼ˆparamséåŒæœŸåŒ–ï¼‰
2. ğŸŸ  **é«˜å„ªå…ˆ**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£
3. ğŸŸ¡ **ä¸­å„ªå…ˆ**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®æœ€é©åŒ–
4. ğŸŸ¢ **ä½å„ªå…ˆ**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„

### 8.3 æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
æ”¹å–„å®Ÿè£…ã¯è¡Œã‚ãšã€ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’åŸºã«å¯¾å¿œæ–¹é‡ã‚’æ±ºå®šã—ã¦ãã ã•ã„ã€‚

---

## ä»˜éŒ²

### A. é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
```
/src/app/api/follow/[userId]/route.ts
/src/app/test-follow/page.tsx
/src/components/FollowButton.tsx
/src/lib/security/rate-limiter-v2.ts
/src/middleware.ts
```

### B. è¨¼æ‹ ãƒ­ã‚°
```
[ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°æŠœç²‹]
Error: Route "/api/follow/[userId]" used `params.userId`
Follow error: CastError: Cast to ObjectId failed for value "test-user-3"
Rate limit exceeded: ::1 - /api/follow/000000000000000000000000
```

### C. å‚è€ƒè³‡æ–™
- [Next.js 15 Migration Guide - Dynamic Params](https://nextjs.org/docs/messages/sync-dynamic-apis)
- [MongoDB ObjectID Specification](https://docs.mongodb.com/manual/reference/method/ObjectId/)

---

**ä½œæˆè€…**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒ   
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: æœªå®Ÿæ–½  
**æ‰¿èª**: æœªæ‰¿èª

**ç½²å**: I attest: all numbers and error messages come from the attached evidence (server logs and test execution).